<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kira Tracker</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; padding: 5px 10px; border-radius: 4px; border: none; }
        .btn-save { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-back { background: #6c757d; color: white; text-decoration: none; padding: 10px 20px; display: inline-block; margin-bottom: 20px; border-radius: 5px; }
    </style>
</head>
<body>
<a href="/" class="btn-back">‚Üê Zur√ºck zur App</a>

<div class="card" id="loginCard">
    <h2>üîí Login erforderlich</h2>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
        <input type="text" id="user" placeholder="User" style="flex:1">
        <input type="password" id="pass" placeholder="Passwort" style="flex:1">
    </div>
    <button onclick="login()" style="background: #007bff; color: white; padding: 10px 20px; width:100%">Einloggen</button>
</div>

<div id="content" style="display: none;">
    <h1>Verwaltung</h1>

    <div class="card">
        <h2>Spazierg√§nge bearbeiten</h2>
        <div id="loading">Lade...</div>
        <table>
            <thead>
            <tr>
                <th style="width:50px">ID</th>
                <th>Person</th>
                <th>Zeit (Format: HH:mm dd.MM.yy)</th>
                <th style="width:150px">Aktionen</th>
            </tr>
            </thead>
            <tbody id="entriesTable"></tbody>
        </table>
    </div>

    <div class="card" style="border: 2px solid #dc3545;">
        <h2 style="color:#dc3545">Gefahrenzone</h2>
        <button onclick="resetAll()" style="background:#dc3545; color:white; padding:10px;">‚ö†Ô∏è Alles unwiderruflich l√∂schen</button>
    </div>
</div>

<script>
    let auth = '';

    function login() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(!u || !p) return alert('Bitte Login eingeben');

        auth = 'Basic ' + btoa(u + ':' + p);
        loadData();
    }

    async function loadData() {
        try {
            // Wir versuchen einen gesch√ºtzten Request, um Login zu testen
            // Cleanup Aufruf als Test
            const res = await fetch('/status');
            const data = await res.json();

            // Login Card weg
            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('loading').style.display = 'none';

            const tbody = document.getElementById('entriesTable');
            tbody.innerHTML = data.entries.map(e => `
                <tr>
                    <td>${e.id}</td>
                    <td><input type="text" value="${e.person}" id="person-${e.id}"></td>
                    <td><input type="text" value="${e.timeFormatted}" id="time-${e.id}"></td>
                    <td>
                        <button class="btn-save" onclick="updateEntry(${e.id})">üíæ</button>
                        <button class="btn-delete" onclick="deleteEntry(${e.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

        } catch (e) {
            console.error(e);
            alert('Fehler beim Laden.');
        }
    }

    async function updateEntry(id) {
        const person = document.getElementById(`person-${id}`).value;
        const time = document.getElementById(`time-${id}`).value;

        try {
            const res = await fetch(`/admin/walk/${id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': auth,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ person, time })
            });

            if(res.ok) {
                alert('Gespeichert!');
                loadData(); // Reload table
            } else if(res.status === 401) {
                alert('Falsches Passwort!');
                location.reload();
            } else {
                alert('Fehler: ' + res.status);
            }
        } catch(e) { console.error(e); }
    }

    async function deleteEntry(id) {
        if(!confirm('Wirklich l√∂schen?')) return;

        try {
            const res = await fetch(`/admin/walk/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': auth }
            });

            if(res.ok) loadData();
            else alert('Fehler beim L√∂schen');
        } catch(e) { console.error(e); }
    }

    async function resetAll() {
        if(!confirm('SICHER? ALLE DATEN GEHEN VERLOREN!')) return;

        try {
            const res = await fetch(`/admin/reset`, {
                method: 'POST',
                headers: { 'Authorization': auth }
            });
            if(res.ok) {
                alert('Alles gel√∂scht.');
                loadData();
            }
        } catch(e) { console.error(e); }
    }
</script>
</body>
</html>
