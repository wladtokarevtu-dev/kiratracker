<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kira Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
          rel="stylesheet">
    <meta name="theme-color" content="#F5F5F7">
    <style>
        :root {
            --bg-light:#FAFAFA;
            --card-light:#FFFFFF;
            --primary-light:#007AFF;
            --text-light:#1D1D1F;
            --text-sec-light:#86868B;
            --input-bg-light:#F5F5F7;
            --border-light:rgba(0,0,0,0.08);

            --bg-dark:#000000;
            --card-dark:#1C1C1E;
            --primary-dark:#0A84FF;
            --text-dark:#F5F5F7;
            --text-sec-dark:#8E8E93;
            --input-bg-dark:#2C2C2E;
            --border-dark:rgba(255,255,255,0.12);

            --bg:var(--bg-light);
            --card:var(--card-light);
            --primary:var(--primary-light);
            --text:var(--text-light);
            --text-sec:var(--text-sec-light);
            --input-bg:var(--input-bg-light);
            --border:var(--border-light);
            --radius:22px;
        }

        body.dark-mode {
            --bg:var(--bg-dark);
            --card:var(--card-dark);
            --primary:var(--primary-dark);
            --text:var(--text-dark);
            --text-sec:var(--text-sec-dark);
            --input-bg:var(--input-bg-dark);
            --border:var(--border-dark);
        }

        * {
            margin:0;
            padding:0;
            box-sizing:border-box;
            -webkit-tap-highlight-color:transparent;
        }

        body {
            font-family:"Inter",-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
            letter-spacing:-0.01em;
            line-height:1.45;
            background:radial-gradient(circle at 35% 18%,#FFFFFF 0%,#F0F0F5 35%,#E8E8ED 70%,#FAFAFA 100%);
            color:var(--text);
            min-height:100vh;
            padding:20px;
            max-width:500px;
            margin:0 auto;
            padding-top:100px;
            transition:opacity 0.4s cubic-bezier(0.16,1,0.3,1),
            transform 0.4s cubic-bezier(0.16,1,0.3,1),
            background 0.4s cubic-bezier(0.16,1,0.3,1),
            color 0.3s ease-out;
            opacity:0;
            transform:translateY(8px);
        }

        body.ready {
            opacity:1;
            transform:translateY(0);
        }

        body.dark-mode {
            background:radial-gradient(circle at 35% 18%,#0d0d0d 0%,#000000 55%,#0a0a0a 100%);
        }

        body::before {
            content:'';
            position:fixed;
            inset:-50%;
            background:radial-gradient(circle,rgba(102,126,234,0.06) 0%,transparent 65%);
            animation:shimmer 14s infinite linear;
            pointer-events:none;
            z-index:-1;
        }

        body.dark-mode::before {
            background:radial-gradient(circle,rgba(102,126,234,0.12) 0%,transparent 65%);
        }

        @keyframes shimmer {
            0% { transform:translate(-25%, -25%) rotate(0deg); }
            100% { transform:translate(25%, 25%) rotate(360deg); }
        }

        .controls {
            position:fixed;
            top:25px;
            right:20px;
            display:flex;
            gap:10px;
            z-index:10;
        }

        .pill {
            background:rgba(255,255,255,0.95);
            backdrop-filter:blur(20px) saturate(200%);
            -webkit-backdrop-filter:blur(20px) saturate(200%);
            padding:6px;
            border-radius:100px;
            display:flex;
            gap:4px;
            cursor:pointer;
            border:1px solid rgba(0,0,0,0.08);
            box-shadow:0 12px 40px rgba(0,0,0,0.12),
            0 2px 8px rgba(0,0,0,0.06),
            inset 0 1px 0 rgba(255,255,255,0.8);
            transition:transform 0.2s cubic-bezier(0.19,1,0.22,1),
            box-shadow 0.2s ease-out;
        }

        body.dark-mode .pill {
            background:rgba(30,30,30,0.85);
            border-color:rgba(255,255,255,0.15);
            box-shadow:0 12px 40px rgba(0,0,0,0.6),
            inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .pill:hover {
            transform:translateY(-2px) scale(1.02);
            box-shadow:0 16px 50px rgba(0,0,0,0.18),
            inset 0 1px 0 rgba(255,255,255,0.9);
        }

        .pill-opt {
            padding:8px 14px;
            border-radius:100px;
            font-size:0.78rem;
            font-weight:700;
            color:var(--text-sec);
            transition:all 0.25s cubic-bezier(0.19,1,0.22,1);
        }

        .pill-opt.active {
            background:linear-gradient(135deg,var(--text) 0%,var(--text) 100%);
            color:var(--bg);
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
        }

        header {
            text-align:center;
            margin-bottom:35px;
            margin-top:10px;
        }

        h1 {
            font-size:2.6rem;
            font-weight:900;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#F093FB 100%);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            margin-bottom:10px;
            letter-spacing:-0.04em;
            filter:drop-shadow(0 4px 12px rgba(102,126,234,0.25));
        }

        .subtitle {
            color:var(--text-sec);
            font-size:1rem;
            font-weight:600;
        }

        .weather-card {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white;
            border-radius:var(--radius);
            padding:24px;
            margin-bottom:22px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            box-shadow:0 28px 80px rgba(102,126,234,0.55),
            inset 0 1px 0 rgba(255,255,255,0.4);
            position:relative;
            overflow:hidden;
        }

        .weather-card::before {
            content:'';
            position:absolute;
            inset:-50%;
            background:radial-gradient(circle,rgba(255,255,255,0.28) 0%,transparent 70%);
            animation:shimmer 10s infinite linear;
            pointer-events:none;
            opacity:0.9;
        }

        .status-grid {
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:16px;
            margin-bottom:22px;
        }

        .status-box {
            background:rgba(255,255,255,0.95);
            backdrop-filter:blur(24px) saturate(200%);
            -webkit-backdrop-filter:blur(24px) saturate(200%);
            border-radius:var(--radius);
            padding:22px;
            text-align:center;
            height:130px;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            position:relative;
            overflow:hidden;
            box-shadow:0 16px 48px rgba(0,0,0,0.12),
            inset 0 1px 0 rgba(255,255,255,0.9);
            border:1px solid rgba(255,255,255,0.8);
        }

        body.dark-mode .status-box {
            background:rgba(28,28,30,0.85);
            border-color:rgba(255,255,255,0.15);
            box-shadow:0 16px 48px rgba(0,0,0,0.7),
            inset 0 1px 0 rgba(255,255,255,0.12);
        }

        .status-box.done {
            background:rgba(228,249,232,0.96);
            color:#1E6F30;
            border-color:rgba(76,217,100,0.6);
        }

        body.dark-mode .status-box.done {
            background:rgba(17,51,27,0.9);
            color:#4CD964;
            border-color:rgba(76,217,100,0.4);
        }

        .status-box.open {
            background:rgba(255,240,240,0.96);
            color:#D63031;
            border-color:rgba(255,69,58,0.6);
        }

        body.dark-mode .status-box.open {
            background:rgba(58,15,15,0.9);
            color:#FF453A;
            border-color:rgba(255,69,58,0.4);
        }

        .status-box.done::after {
            content:"";
            position:absolute;
            inset:0;
            background:radial-gradient(circle at center,rgba(255,255,255,0.9),transparent 65%);
            opacity:0;
            transform:scale(0.6);
            pointer-events:none;
        }

        .status-box.done.animate-ping::after {
            animation:ping 0.6s cubic-bezier(0.19,1,0.22,1);
        }

        @keyframes ping {
            0%   { opacity:0.9; transform:scale(0.6); }
            100% { opacity:0;   transform:scale(1.4); }
        }

        .card {
            background:rgba(255,255,255,0.95);
            backdrop-filter:blur(32px) saturate(200%);
            -webkit-backdrop-filter:blur(32px) saturate(200%);
            border-radius:var(--radius);
            padding:26px;
            margin-bottom:22px;
            box-shadow:0 32px 80px rgba(0,0,0,0.15),
            0 8px 28px rgba(0,0,0,0.08),
            inset 0 1px 0 rgba(255,255,255,1);
            border:1px solid rgba(255,255,255,0.8);
            position:relative;
        }

        body.dark-mode .card {
            background:rgba(28,28,30,0.85);
            border-color:rgba(255,255,255,0.15);
            box-shadow:0 32px 80px rgba(0,0,0,0.8),
            inset 0 1px 0 rgba(255,255,255,0.12);
        }

        .card::before {
            content:'';
            position:absolute;
            inset:0;
            border-radius:var(--radius);
            padding:1px;
            background:linear-gradient(145deg,rgba(255,255,255,0.9),transparent 40%);
            -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
            -webkit-mask-composite:xor;
            mask-composite:exclude;
            pointer-events:none;
            opacity:0.6;
        }

        body.dark-mode .card::before {
            background:linear-gradient(145deg,rgba(255,255,255,0.25),transparent 50%);
            opacity:0.4;
        }

        .input-area {
            display:flex;
            gap:11px;
            margin-top:16px;
            align-items:center;
        }

        input {
            flex:1;
            padding:15px;
            border-radius:13px;
            border:1px solid var(--border);
            background:var(--input-bg);
            color:var(--text);
            font-size:1rem;
            min-width:0;
            font-weight:500;
            transition:box-shadow 0.18s ease-out,
            transform 0.18s ease-out,
            background 0.18s ease-out,
            border-color 0.18s ease-out;
        }

        input:focus {
            outline:none;
            box-shadow:0 0 0 3px rgba(0,122,255,0.25),
            0 4px 12px rgba(0,122,255,0.15);
            transform:translateY(-1px);
            border-color:rgba(0,122,255,0.4);
            background:var(--card);
        }

        .btn-circle {
            width:52px;
            height:52px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--text) 0%,var(--text) 100%);
            color:var(--bg);
            border:none;
            font-size:1.3rem;
            font-weight:700;
            cursor:pointer;
            flex-shrink:0;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 10px 28px rgba(0,0,0,0.22),
            inset 0 1px 0 rgba(255,255,255,0.2);
            transition:transform 0.18s cubic-bezier(0.19,1,0.22,1),
            box-shadow 0.18s ease-out,
            background 0.18s ease-out;
        }

        .btn-circle:hover {
            transform:translateY(-2px) scale(1.03);
            background:linear-gradient(135deg,var(--primary) 0%,#0056D6 100%);
            box-shadow:0 16px 38px rgba(0,122,255,0.35),
            inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .btn-circle:active {
            transform:translateY(0) scale(1);
            box-shadow:0 6px 18px rgba(0,0,0,0.2);
        }

        .quick-row {
            display:flex;
            gap:9px;
            margin-top:16px;
            overflow-x:auto;
            padding-bottom:2px;
        }

        .quick-btn {
            background:var(--input-bg);
            color:var(--primary);
            border:1px solid rgba(0,122,255,0.15);
            padding:9px 15px;
            border-radius:100px;
            font-weight:600;
            font-size:0.87rem;
            cursor:pointer;
            white-space:nowrap;
            box-shadow:0 2px 8px rgba(0,0,0,0.06);
            transition:transform 0.18s cubic-bezier(0.19,1,0.22,1),
            box-shadow 0.18s ease-out,
            background 0.18s ease-out;
        }

        .quick-btn:hover {
            transform:translateY(-1px);
            box-shadow:0 8px 20px rgba(0,122,255,0.18);
            background:rgba(0,122,255,0.08);
        }

        .lb-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:16px;
        }

        .time-switch {
            background:var(--input-bg);
            border-radius:9px;
            padding:3px;
            display:flex;
            border:1px solid var(--border);
        }

        .time-opt {
            padding:5px 10px;
            font-size:0.72rem;
            font-weight:600;
            cursor:pointer;
            border-radius:7px;
            color:var(--text-sec);
            transition:all 0.25s cubic-bezier(0.19,1,0.22,1);
        }

        .time-opt.active {
            background:var(--card);
            color:var(--text);
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
        }

        .lb-row {
            display:flex;
            justify-content:space-between;
            padding:10px 0;
            border-bottom:1px solid var(--border);
            font-size:0.92rem;
        }

        .entry {
            display:flex;
            align-items:center;
            padding:15px 0;
            border-bottom:1px solid var(--border);
        }

        .entry-info { flex:1; }

        .entry-time {
            color:var(--text-sec);
            font-size:0.82rem;
            font-weight:500;
        }

        .entry-text {
            font-weight:600;
            margin-top:2px;
        }

        .btn-icon {
            background:transparent;
            border:none;
            font-size:1.15rem;
            cursor:pointer;
            display:none;
            opacity:0;
            transform:translateY(2px);
            transition:opacity 0.2s ease-out,transform 0.2s ease-out;
            padding:4px 6px;
        }

        body.admin-mode .entry:hover .btn-icon {
            display:inline-block;
            opacity:1;
            transform:translateY(0);
        }

        .wa-card {
            background:rgba(233,252,242,0.95);
            backdrop-filter:blur(16px);
            -webkit-backdrop-filter:blur(16px);
            color:#0C4A28;
            padding:20px;
            border-radius:var(--radius);
            margin-top:32px;
            text-align:center;
            cursor:pointer;
            border:1px solid rgba(76,217,100,0.25);
            box-shadow:0 18px 48px rgba(12,74,40,0.15),
            inset 0 1px 0 rgba(255,255,255,0.6);
            transition:transform 0.2s ease-out,box-shadow 0.2s ease-out;
        }

        .wa-card:hover {
            transform:translateY(-2px);
            box-shadow:0 24px 60px rgba(12,74,40,0.22),
            inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .gamble-card {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white;
            padding:20px;
            border-radius:var(--radius);
            margin-top:16px;
            text-align:center;
            cursor:pointer;
            border:1px solid rgba(255,255,255,0.3);
            box-shadow:0 28px 76px rgba(102,126,234,0.6),
            inset 0 1px 0 rgba(255,255,255,0.4);
            transition:transform 0.2s ease-out,box-shadow 0.2s ease-out;
        }

        .gamble-card:hover {
            transform:translateY(-2px) scale(1.01);
            box-shadow:0 36px 90px rgba(102,126,234,0.75),
            inset 0 1px 0 rgba(255,255,255,0.5);
        }

        .error-toast {
            position:fixed;
            top:80px;
            left:50%;
            transform:translate(-50%,-12px);
            background:#FF453A;
            color:white;
            padding:14px 22px;
            border-radius:14px;
            font-size:0.92rem;
            font-weight:600;
            z-index:100;
            box-shadow:0 8px 24px rgba(255,69,58,0.4),
            inset 0 1px 0 rgba(255,255,255,0.2);
            opacity:0;
            pointer-events:none;
            transition:transform 0.3s cubic-bezier(0.19,1,0.22,1),
            opacity 0.3s cubic-bezier(0.19,1,0.22,1);
        }

        .error-toast.show {
            opacity:1;
            transform:translate(-50%,0);
            pointer-events:auto;
        }
    </style>
</head>
<body>
<div class="error-toast" id="errorToast"></div>

<div class="controls">
    <div class="pill" onclick="toggleLang()">
        <div class="pill-opt active" id="l-de">DE</div>
        <div class="pill-opt" id="l-ru">RU</div>
    </div>
    <div class="pill" onclick="toggleDark()">
        <div class="pill-opt active" id="dm-light">‚òÄÔ∏è</div>
        <div class="pill-opt" id="dm-dark">üåô</div>
    </div>
    <div class="pill" onclick="toggleAdmin()">
        <div class="pill-opt" id="admin-label">Admin</div>
    </div>
</div>

<header>
    <h1>Kira Tracker</h1>
    <div class="subtitle">Spazierg√§nge & F√ºtterung</div>
</header>

<div class="weather-card">
    <div style="font-size:2.1rem;font-weight:800" id="wTemp">--¬∞</div>
    <div id="wDesc" style="font-weight:500;font-size:0.95rem">L√§dt...</div>
</div>

<div class="status-grid">
    <div class="status-box open" id="morningBox">
        <div style="font-size:2.2rem">üåÖ</div>
        <div style="font-weight:600;font-size:0.82rem;margin-top:6px"
             data-i18n="status-morning-title">Morgens Spaziergang</div>
        <div id="morningStatus" style="font-weight:700;margin-top:4px"
             data-i18n-status-morning>Offen</div>
    </div>
    <div class="status-box open" id="eveningBox">
        <div style="font-size:2.2rem">üåá</div>
        <div style="font-weight:600;font-size:0.82rem;margin-top:6px"
             data-i18n="status-evening-title">Abends Spaziergang</div>
        <div id="eveningStatus" style="font-weight:700;margin-top:4px"
             data-i18n-status-evening>Offen</div>
    </div>
</div>

<div class="card">
    <h3 style="font-size:1.05rem;font-weight:700;margin-bottom:12px"
        data-i18n="walk-title">üêï Spaziergang eintragen</h3>
    <div class="input-area">
        <input type="text" id="nameInput" placeholder="Name..."
               data-i18n-placeholder="name-placeholder"/>
        <button class="btn-circle" onclick="addWalk()">+</button>
    </div>
    <div class="quick-row">
        <button class="quick-btn" onclick="quickAdd('Wlad')">Wlad</button>
        <button class="quick-btn" onclick="quickAdd('Mama')">Mama</button>
        <button class="quick-btn" onclick="quickAdd('Ilja')">Ilja</button>
        <button class="quick-btn" onclick="quickAdd('Aaron')">Aaron</button>
        <button class="quick-btn" onclick="quickAdd('Dajen')">Dajen</button>
    </div>
</div>

<div class="card">
    <h3 style="font-size:1.05rem;font-weight:700;margin-bottom:12px">ü•£ F√ºtterung</h3>
    <div id="foodList"></div>
    <div class="input-area" style="margin-top:12px">
        <input type="text" id="foodName" placeholder="Wer?" style="flex:1" />
        <input type="text" id="foodDesc" placeholder="Was? (Optional)" style="flex:1.5" />
        <button class="btn-circle" onclick="addFood()">‚úì</button>
    </div>
    <div class="quick-row">
        <button class="quick-btn" onclick="quickFood('Mama')">Mama</button>
        <button class="quick-btn" onclick="quickFood('Wlad')">Wlad</button>
        <button class="quick-btn" onclick="quickFood('Ilja')">Ilja</button>
        <button class="quick-btn" onclick="quickFood('Dajen')">Dajen</button>
    </div>
</div>

<div class="card">
    <div class="lb-header">
        <div style="font-weight:700;font-size:1.05rem">üèÜ Leaderboard</div>
        <div class="time-switch">
            <div class="time-opt active" onclick="setLbDays(3,this)">3d</div>
            <div class="time-opt" onclick="setLbDays(7,this)">7d</div>
            <div class="time-opt" onclick="setLbDays(14,this)">14d</div>
            <div class="time-opt" onclick="setLbDays(30,this)">30d</div>
        </div>
    </div>
    <div id="leaderboardList"></div>
</div>

<div style="font-weight:700;margin:32px 0 12px 6px;font-size:1.05rem">Verlauf</div>
<div class="card" id="historyList" style="padding:12px 22px"></div>

<div class="wa-card" onclick="window.location.href='v2.html'">
    <div style="font-weight:700;font-size:1.05rem" data-i18n="wa-title">üí¨ WhatsApp Anfrage</div>
    <div style="font-size:0.88rem;opacity:0.85;margin-top:3px" data-i18n="wa-subtitle">
        Benachrichtigung senden
    </div>
</div>

<div class="gamble-card" onclick="window.location.href='gamble.html'">
    <div style="font-weight:800;font-size:1.1rem">üé≤ Gamble: Wer geht raus?</div>
    <div style="font-size:0.88rem;opacity:0.92;margin-top:3px">
        Zuf√§llig eine Person ziehen
    </div>
</div>

<script>
    const API = window.location.origin;
    let lang = 'de';
    let currentLbDays = 3;
    let fullHistoryCache = [];

    const translations = {
        de: {
            title: 'Kira Tracker',
            subtitle: 'Spazierg√§nge & F√ºtterung',
            'status-morning-title': 'Morgens Spaziergang',
            'status-evening-title': 'Abends Spaziergang',
            'walk-title': 'üêï Spaziergang eintragen',
            'name-placeholder': 'Name...',
            'toast-name-missing': 'Bitte Namen angeben!',
            'toast-save-error': 'Fehler beim Speichern',
            'toast-delete-error': 'Fehler beim L√∂schen',
            'history-empty': 'Noch keine Eintr√§ge',
            'lb-empty': 'Keine Daten',
            'wa-title': 'üí¨ WhatsApp Anfrage',
            'wa-subtitle': 'Benachrichtigung senden',
            'status-open': 'Offen',
            'status-done': 'Erledigt ‚úì'
        },
        ru: {
            title: '–ö–∏—Ä–∞ —Ç—Ä–µ–∫–µ—Ä',
            subtitle: '–ü—Ä–æ–≥—É–ª–∫–∏ –∏ –∫–æ—Ä–º–ª–µ–Ω–∏–µ',
            'status-morning-title': '–£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≥—É–ª–∫–∞',
            'status-evening-title': '–í–µ—á–µ—Ä–Ω—è—è –ø—Ä–æ–≥—É–ª–∫–∞',
            'walk-title': 'üêï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—É–ª–∫—É',
            'name-placeholder': '–ò–º—è...',
            'toast-name-missing': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è!',
            'toast-save-error': '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏',
            'toast-delete-error': '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏',
            'history-empty': '–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç',
            'lb-empty': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
            'wa-title': 'üí¨ –ó–∞–ø—Ä–æ—Å –≤ WhatsApp',
            'wa-subtitle': '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
            'status-open': '–û—Ç–∫—Ä—ã—Ç–æ',
            'status-done': '–°–¥–µ–ª–∞–Ω–æ ‚úì'
        }
    };

    async function fetchJSON(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            }
            return null;
        } catch (error) {
            console.error('Fetch Error:', error);
            throw error;
        }
    }

    function showError(message) {
        const toast = document.getElementById('errorToast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function applyTranslations() {
        const t = translations[lang];

        const h1 = document.querySelector('h1');
        if (h1) h1.textContent = t.title;

        const subtitle = document.querySelector('.subtitle');
        if (subtitle) subtitle.textContent = t.subtitle;

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.textContent = t[key];
        });

        const nameInput = document.getElementById('nameInput');
        if (nameInput && t['name-placeholder']) {
            nameInput.placeholder = t['name-placeholder'];
        }

        const mStatus = document.getElementById('morningStatus');
        const eStatus = document.getElementById('eveningStatus');
        if (mStatus && mStatus.dataset.state) {
            mStatus.textContent = mStatus.dataset.state === 'done'
                ? t['status-done']
                : t['status-open'];
        }
        if (eStatus && eStatus.dataset.state) {
            eStatus.textContent = eStatus.dataset.state === 'done'
                ? t['status-done']
                : t['status-open'];
        }
    }

    function toggleLang() {
        lang = lang === 'de' ? 'ru' : 'de';
        localStorage.setItem('lang', lang);

        document.getElementById('l-de').classList.toggle('active');
        document.getElementById('l-ru').classList.toggle('active');

        applyTranslations();
        loadStatus();
        loadFood();
        renderHistory(); // nur Anzeige, Cache bleibt
        loadLeaderboard(getCurrentLbDays());
    }

    function initLang() {
        lang = localStorage.getItem('lang') || 'de';
        if (lang === 'ru') {
            document.getElementById('l-de').classList.remove('active');
            document.getElementById('l-ru').classList.add('active');
        }
        applyTranslations();
    }

    function initDarkMode() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const saved = localStorage.getItem('darkMode');
        const useDark = saved ? saved === 'dark' : prefersDark;

        document.body.classList.toggle('dark-mode', useDark);
        document.getElementById('dm-dark').classList.toggle('active', useDark);
        document.getElementById('dm-light').classList.toggle('active', !useDark);
    }

    function toggleDark() {
        const isDark = !document.body.classList.contains('dark-mode');
        document.body.classList.toggle('dark-mode', isDark);
        document.getElementById('dm-dark').classList.toggle('active', isDark);
        document.getElementById('dm-light').classList.toggle('active', !isDark);
        localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('darkMode')) {
            const isDark = e.matches;
            document.body.classList.toggle('dark-mode', isDark);
            document.getElementById('dm-dark').classList.toggle('active', isDark);
            document.getElementById('dm-light').classList.toggle('active', !isDark);
        }
    });

    async function loadWeather() {
        try {
            const data = await fetchJSON(API + '/api/weather');
            if (data && data.temp !== undefined) {
                document.getElementById('wTemp').textContent =
                    Math.round(data.temp) + '¬∞C';
                document.getElementById('wDesc').textContent =
                    data.description || 'Keine Daten';
            } else {
                document.getElementById('wTemp').textContent = '--¬∞';
                document.getElementById('wDesc').textContent = 'Keine Daten';
            }
        } catch (error) {
            document.getElementById('wTemp').textContent = '--¬∞';
            document.getElementById('wDesc').textContent = 'Offline';
        }
    }

    async function loadStatus() {
        try {
            const data = await fetchJSON(API + '/status');

            const mBox = document.getElementById('morningBox');
            const eBox = document.getElementById('eveningBox');
            const mStatus = document.getElementById('morningStatus');
            const eStatus = document.getElementById('eveningStatus');

            const t = translations[lang];

            const wasMorning = !!data.wasMorning;
            const wasEvening = !!data.wasEvening;

            if (wasMorning) {
                mBox.classList.add('done');
                mBox.classList.remove('open');
                mStatus.dataset.state = 'done';
                mStatus.textContent = t['status-done'];
                mBox.classList.add('animate-ping');
                setTimeout(() => mBox.classList.remove('animate-ping'), 600);
            } else {
                mBox.classList.add('open');
                mBox.classList.remove('done');
                mStatus.dataset.state = 'open';
                mStatus.textContent = t['status-open'];
            }

            if (wasEvening) {
                eBox.classList.add('done');
                eBox.classList.remove('open');
                eStatus.dataset.state = 'done';
                eStatus.textContent = t['status-done'];
                eBox.classList.add('animate-ping');
                setTimeout(() => eBox.classList.remove('animate-ping'), 600);
            } else {
                eBox.classList.add('open');
                eBox.classList.remove('done');
                eStatus.dataset.state = 'open';
                eStatus.textContent = t['status-open'];
            }
        } catch (error) {
            console.log('Status Fehler:', error);
        }
    }

    async function addWalk() {
        const person = document.getElementById('nameInput').value.trim();

        if (!person) {
            showError(translations[lang]['toast-name-missing']);
            return;
        }

        try {
            await fetchJSON(API + '/api/walk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ person })
            });

            document.getElementById('nameInput').value = '';
            await loadHistory();
            await loadStatus();
            await loadLeaderboard(getCurrentLbDays());
        } catch (error) {
            showError(translations[lang]['toast-save-error']);
        }
    }

    function quickAdd(name) {
        document.getElementById('nameInput').value = name;
        addWalk();
    }

    async function addFood() {
        const person = document.getElementById('foodName').value.trim();
        const food = document.getElementById('foodDesc').value.trim() || '';

        if (!person) {
            showError('Bitte Namen angeben!');
            return;
        }

        try {
            await fetchJSON(API + '/api/food', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ person, food })
            });

            document.getElementById('foodName').value = '';
            document.getElementById('foodDesc').value = '';
            await loadFood();
            await loadStatus();
        } catch (error) {
            showError('Fehler beim Speichern');
        }
    }

    function quickFood(name) {
        document.getElementById('foodName').value = name;
        document.getElementById('foodDesc').focus();
    }

    async function loadFood() {
        try {
            const data = await fetchJSON(API + '/api/food');
            const list = document.getElementById('foodList');

            if (!Array.isArray(data) || data.length === 0) {
                list.innerHTML =
                    '<div style="text-align:center;color:var(--text-sec);padding:12px;font-size:0.92rem;font-weight:500">Noch keine Eintr√§ge heute</div>';
                return;
            }

            list.innerHTML = data.map(f => {
                let timestamp = '';
                if (f.timestamp) {
                    try {
                        const date = new Date(f.timestamp);
                        timestamp = date.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });
                    } catch (e) {
                        timestamp = '';
                    }
                }
                const person = f.person || '';
                const food = f.food || '';

                return (
                    '<div class="entry">' +
                    '<div class="entry-info">' +
                    '<div class="entry-time">' + timestamp + '</div>' +
                    '<div class="entry-text">' + person + (food ? ': ' + food : '') + '</div>' +
                    '</div>' +
                    '<button class="btn-icon" onclick="editFood(' + f.id + ', \'' + person + '\', \'' + food.replace(/'/g, "\\'") + '\')">‚úèÔ∏è</button>' +
                    '<button class="btn-icon" onclick="deleteFood(' + f.id + ')">üóëÔ∏è</button>' +
                    '</div>'
                );
            }).join('');
        } catch (error) {
            document.getElementById('foodList').innerHTML =
                '<div style="text-align:center;color:var(--text-sec);padding:12px">Fehler beim Laden</div>';
        }
    }

    async function deleteFood(id) {
        if (!document.body.classList.contains('admin-mode')) return;
        if (!confirm('Wirklich l√∂schen?')) return;

        try {
            await fetchJSON(API + '/admin/food/' + id, { method: 'DELETE' });
            await loadFood();
            await loadStatus();
        } catch (error) {
            showError('Fehler beim L√∂schen');
        }
    }

    function editFood(id, person, desc) {
        if (!document.body.classList.contains('admin-mode')) return;

        const newPerson = prompt('Wer?', person || '');
        if (newPerson === null) return;

        const newDesc = prompt('Was?', desc || '');
        if (newDesc === null) return;

        fetchJSON(API + '/admin/food/' + id, { method: 'DELETE' })
            .then(() => fetchJSON(API + '/api/food', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ person: newPerson, food: newDesc })
            }))
            .then(() => {
                loadFood();
                loadStatus();
            })
            .catch(() => showError('Fehler beim Speichern'));
    }

    async function loadHistory() {
        try {
            const data = await fetchJSON(API + '/api/walk');
            fullHistoryCache = Array.isArray(data) ? data : [];
            renderHistory(false);
        } catch (error) {
            document.getElementById('historyList').innerHTML =
                '<div style="text-align:center;color:var(--text-sec);padding:12px">Fehler beim Laden</div>';
        }
    }

    function renderHistory(showAll = false) {
        const list = document.getElementById('historyList');
        const data = fullHistoryCache;

        if (!Array.isArray(data) || data.length === 0) {
            list.innerHTML =
                '<div style="text-align:center;color:var(--text-sec);padding:12px;font-size:0.92rem;font-weight:500">'
                + translations[lang]['history-empty'] + '</div>';
            return;
        }

        const limit = showAll ? 10 : 3;
        const display = data.slice(0, limit);

        list.innerHTML = display.map(w => {
            const timestamp = w.timestamp || '';
            const person = w.person || '';
            return (
                '<div class="entry">' +
                '<div class="entry-info">' +
                '<div class="entry-time">' + timestamp + '</div>' +
                '<div class="entry-text">' + person + '</div>' +
                '</div>' +
                '<button class="btn-icon" onclick="editWalk(' + w.id + ', \'' + person + '\', \'' + timestamp + '\')">‚úèÔ∏è</button>' +
                '<button class="btn-icon" onclick="deleteWalk(' + w.id + ')">üóëÔ∏è</button>' +
                '</div>'
            );
        }).join('');

        if (data.length > limit) {
            const label = showAll
                ? 'Weniger anzeigen'
                : `+ ${Math.min(data.length,10) - 3} weitere anzeigen`;
            list.innerHTML +=
                '<div style="text-align:center;padding:12px;color:var(--primary);cursor:pointer;font-weight:700;font-size:0.92rem" onclick="toggleHistoryView(' + (!showAll) + ')">'
                + label + '</div>';
        }
    }

    function toggleHistoryView(showAllFlag) {
        renderHistory(showAllFlag);
    }

    function editWalk(id, person, timeStr) {
        if (!document.body.classList.contains('admin-mode')) return;

        const newPerson = prompt('Name √§ndern:', person || '');
        if (newPerson === null) return;

        const newTime = prompt('Zeit √§ndern (HH:mm dd.MM.yy) oder leer lassen:', timeStr || '');
        const payload = { person: newPerson };
        if (newTime && newTime.trim() !== '') {
            payload.time = newTime.trim();
        }

        fetchJSON(API + '/admin/walk/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(() => {
                loadHistory();
                loadStatus();
                loadLeaderboard(getCurrentLbDays());
            })
            .catch(() => showError('Fehler beim Speichern'));
    }

    async function deleteWalk(id) {
        if (!document.body.classList.contains('admin-mode')) return;
        if (!confirm('Wirklich l√∂schen?')) return;

        try {
            await fetchJSON(API + '/admin/walk/' + id, { method: 'DELETE' });
            await loadHistory();
            await loadStatus();
            await loadLeaderboard(getCurrentLbDays());
        } catch (error) {
            showError(translations[lang]['toast-delete-error']);
        }
    }

    function getCurrentLbDays() {
        return currentLbDays;
    }

    async function loadLeaderboard(days) {
        currentLbDays = days;
        try {
            const data = await fetchJSON(API + '/api/leaderboard?days=' + days);
            const list = document.getElementById('leaderboardList');

            if (!data || Object.keys(data).length === 0) {
                list.innerHTML =
                    '<div style="text-align:center;color:var(--text-sec);padding:12px;font-size:0.92rem;font-weight:500">'
                    + translations[lang]['lb-empty'] + '</div>';
                return;
            }

            list.innerHTML = Object.entries(data)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count], index) => {
                    const medal =
                        index === 0 ? 'ü•á ' :
                            index === 1 ? 'ü•à ' :
                                index === 2 ? 'ü•â ' : '';
                    return (
                        '<div class="lb-row"><span style="font-weight:600">' + medal + name +
                        '</span><span style="font-weight:800">' + count +
                        '</span></div>'
                    );
                })
                .join('');
        } catch (error) {
            document.getElementById('leaderboardList').innerHTML =
                '<div style="text-align:center;color:var(--text-sec);padding:12px">Fehler beim Laden</div>';
        }
    }

    function setLbDays(days, el) {
        document.querySelectorAll('.time-opt')
            .forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        loadLeaderboard(days);
    }

    function toggleAdmin() {
        if (document.body.classList.contains('admin-mode')) {
            document.body.classList.remove('admin-mode');
            document.getElementById('admin-label').classList.remove('active');
            return;
        }

        fetch(API + '/admin', { method: 'GET' })
            .then(resp => {
                if (resp.ok) {
                    document.body.classList.add('admin-mode');
                    document.getElementById('admin-label').classList.add('active');
                } else if (resp.status === 401) {
                    return fetch(API + '/admin', { method: 'GET' });
                }
            })
            .then(resp2 => {
                if (resp2 && resp2.ok) {
                    document.body.classList.add('admin-mode');
                    document.getElementById('admin-label').classList.add('active');
                }
            })
            .catch(() => {});
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => document.body.classList.add('ready'), 50);
        initLang();
        initDarkMode();
        loadWeather();
        loadStatus();
        loadFood();
        loadHistory();
        loadLeaderboard(3);
    });

    setInterval(() => {
        loadWeather();
        loadStatus();
        loadFood();
        loadHistory();
    }, 60000);
</script>
</body>
</html>
